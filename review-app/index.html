<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Spooky Vocab - å¤ä¹ ç³»ç»Ÿ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
      font-size: 14px;
    }

    .card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .login-view, .main-view {
      display: none;
    }

    .login-view.active, .main-view.active {
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
    }

    .form-group input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #f5f5f5;
      color: #666;
      margin-top: 10px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-item {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      color: #666;
    }

    .flip-card {
      perspective: 1000px;
      height: 300px;
      margin-bottom: 20px;
    }

    .flip-card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }

    .flip-card.flipped .flip-card-inner {
      transform: rotateY(180deg);
    }

    .flip-card-front, .flip-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 30px;
    }

    .flip-card-front {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .flip-card-back {
      background: white;
      border: 3px solid #667eea;
      transform: rotateY(180deg);
    }

    .word-text {
      font-size: 48px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .phonetic-text {
      font-size: 22px;
      color: #667eea;
      font-family: 'Lucida Sans Unicode', 'Times New Roman', serif;
      margin-top: 10px;
    }

    .translation-text {
      font-size: 24px;
      color: #333;
      margin-bottom: 15px;
    }

    .context-text {
      font-size: 14px;
      color: #666;
      line-height: 1.6;
    }

    .grade-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .btn-grade {
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-again {
      background: #ff6b6b;
      color: white;
    }

    .btn-hard {
      background: #ffa502;
      color: white;
    }

    .btn-good {
      background: #4ecdc4;
      color: white;
    }

    .btn-easy {
      background: #95e1d3;
      color: white;
    }

    .btn-grade:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .message {
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 15px;
      font-size: 14px;
    }

    .message-success {
      background: #d4edda;
      color: #155724;
    }

    .message-error {
      background: #f8d7da;
      color: #721c24;
    }

    .message-info {
      background: #d1ecf1;
      color: #0c5460;
    }

    .hidden {
      display: none !important;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    @media (max-width: 600px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .word-text {
        font-size: 36px;
      }
      
      .translation-text {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ‘» Spooky Vocab</h1>
      <p>æ™ºèƒ½è‹±è¯­å•è¯å¤ä¹ ç³»ç»Ÿ | FSRSç®—æ³•é©±åŠ¨</p>
    </div>

    <!-- ç™»å½•è§†å›¾ -->
    <div class="login-view active" id="loginView">
      <div class="card">
        <h2 style="margin-bottom: 20px; color: #333;">å¼€å§‹ä½¿ç”¨</h2>
        <div class="form-group">
          <label>ç”¨æˆ·ID</label>
          <input type="text" id="userId" placeholder="è¾“å…¥ç”¨æˆ·ID" value="test_user">
        </div>
        <div class="form-group">
          <label>APIåœ°å€</label>
          <input type="text" id="apiUrl" placeholder="APIåœ°å€" value="https://kuroneko.chat/vocab-api">
        </div>
        <button class="btn btn-primary" onclick="app.login()">ç™»å½•</button>
        <div id="loginMessage"></div>
      </div>
    </div>

    <!-- ä¸»è§†å›¾ -->
    <div class="main-view" id="mainView">
      <!-- ç”¨æˆ·ä¿¡æ¯æ  -->
      <div class="card" style="padding: 15px 20px; margin-bottom: 15px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 20px;">ğŸ‘¤</span>
            <span style="color: #333; font-weight: 500;" id="currentUserDisplay">-</span>
          </div>
          <button onclick="app.logout()" style="background: #f44336; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px; cursor: pointer;">
            é€€å‡ºç™»å½•
          </button>
        </div>
      </div>

      <!-- ç»Ÿè®¡å¡ç‰‡ -->
      <div class="card">
        <h3 style="margin-bottom: 20px; color: #333;">å­¦ä¹ ç»Ÿè®¡</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" id="statDueToday">-</div>
            <div class="stat-label">ä»Šæ—¥å¾…å¤ä¹ </div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="statCompleted">-</div>
            <div class="stat-label">ä»Šæ—¥å·²å®Œæˆ</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="statTotal">-</div>
            <div class="stat-label">æ€»è¯æ±‡é‡</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="statStreak">-</div>
            <div class="stat-label">è¿ç»­å­¦ä¹ å¤©æ•°</div>
          </div>
        </div>
        <button class="btn btn-primary" onclick="app.startReview()">å¼€å§‹å¤ä¹ </button>
        <button class="btn btn-secondary" onclick="app.loadStats()">åˆ·æ–°ç»Ÿè®¡</button>
        <button class="btn btn-secondary" onclick="app.refreshWords()" style="margin-top: 10px;">ğŸ”„ åˆ·æ–°å•è¯åˆ—è¡¨</button>
      </div>

      <!-- å¤ä¹ å¡ç‰‡ -->
      <div class="card hidden" id="reviewCard">
        <div id="reviewMessage"></div>
        
        <div class="flip-card" id="flipCard" onclick="app.flipCard()">
          <div class="flip-card-inner">
            <div class="flip-card-front">
              <div class="word-text" id="wordText">-</div>
              <div class="phonetic-text" id="phoneticText">-</div>
              <p style="margin-top: 20px; opacity: 0.8; font-size: 14px;">ç‚¹å‡»ç¿»è½¬æŸ¥çœ‹é‡Šä¹‰</p>
            </div>
            <div class="flip-card-back">
              <div class="translation-text" id="translationText">-</div>
              <div class="context-text" id="contextText">-</div>
            </div>
          </div>
        </div>

        <div class="grade-buttons">
          <button class="btn-grade btn-again" onclick="app.submitGrade(1)">
            ğŸ˜° Again<br><small>å®Œå…¨ä¸è®°å¾—</small>
          </button>
          <button class="btn-grade btn-hard" onclick="app.submitGrade(2)">
            ğŸ˜“ Hard<br><small>å¾ˆéš¾æƒ³èµ·</small>
          </button>
          <button class="btn-grade btn-good" onclick="app.submitGrade(3)">
            ğŸ˜Š Good<br><small>æ­£å¸¸è®°èµ·</small>
          </button>
          <button class="btn-grade btn-easy" onclick="app.submitGrade(4)">
            ğŸ˜ Easy<br><small>è½»æ¾è®°èµ·</small>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const app = {
      apiUrl: '',
      token: '',
      currentCard: null,
      cards: [],
      currentIndex: 0,
      reviewStartTime: null,

      // åˆå§‹åŒ– - æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
      init() {
        const savedToken = localStorage.getItem('token');
        const savedApiUrl = localStorage.getItem('apiUrl');
        const savedUserId = localStorage.getItem('userId');
        
        if (savedToken && savedApiUrl && savedUserId) {
          this.token = savedToken;
          this.apiUrl = savedApiUrl;
          
          // è‡ªåŠ¨ç™»å½•
          document.getElementById('loginView').classList.remove('active');
          document.getElementById('mainView').classList.add('active');
          document.getElementById('currentUserDisplay').textContent = savedUserId;
          this.loadStats();
        }
      },

      // é€€å‡ºç™»å½•
      logout() {
        if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) return;
        
        localStorage.removeItem('token');
        localStorage.removeItem('apiUrl');
        localStorage.removeItem('userId');
        
        this.token = '';
        this.apiUrl = '';
        
        document.getElementById('mainView').classList.remove('active');
        document.getElementById('loginView').classList.add('active');
        document.getElementById('currentUserDisplay').textContent = '-';
      },

      // ç™»å½•
      async login() {
        const userId = document.getElementById('userId').value.trim();
        const apiUrl = document.getElementById('apiUrl').value.trim();

        if (!userId || !apiUrl) {
          this.showMessage('loginMessage', 'error', 'è¯·å¡«å†™ç”¨æˆ·IDå’ŒAPIåœ°å€');
          return;
        }

        this.apiUrl = apiUrl;

        try {
          this.showMessage('loginMessage', 'info', 'æ­£åœ¨è¿æ¥...');
          
          // è·å–JWT token
          const response = await fetch(`${apiUrl}/api/auth/test-token`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId })
          });

          const data = await response.json();
          
          if (data.success) {
            this.token = data.data.token;
            localStorage.setItem('token', this.token);
            localStorage.setItem('apiUrl', this.apiUrl);
            localStorage.setItem('userId', userId);
            
            this.showMessage('loginMessage', 'success', 'ç™»å½•æˆåŠŸï¼');
            
            setTimeout(() => {
              document.getElementById('loginView').classList.remove('active');
              document.getElementById('mainView').classList.add('active');
              document.getElementById('currentUserDisplay').textContent = userId;
              this.loadStats();
            }, 500);
          } else {
            this.showMessage('loginMessage', 'error', 'ç™»å½•å¤±è´¥ï¼š' + data.error.message);
          }
        } catch (error) {
          this.showMessage('loginMessage', 'error', 'è¿æ¥å¤±è´¥ï¼š' + error.message);
        }
      },

      // åŠ è½½ç»Ÿè®¡æ•°æ®
      async loadStats() {
        try {
          const response = await this.apiRequest('/api/sr/stats');
          
          if (response.success) {
            const stats = response.data;
            document.getElementById('statDueToday').textContent = stats.overview.due_today;
            document.getElementById('statCompleted').textContent = stats.overview.completed_today;
            document.getElementById('statTotal').textContent = stats.overview.total_cards;
            document.getElementById('statStreak').textContent = stats.activity.study_streak_days;
          }
        } catch (error) {
          console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
        }
      },

      // å¼€å§‹å¤ä¹ 
      async startReview() {
        try {
          // è·å–å¾…å¤ä¹ å•è¯
          const response = await this.apiRequest('/api/sr/due?limit=20');
          
          if (response.success) {
            this.cards = response.data.cards;
            this.currentIndex = 0;
            
            if (this.cards.length === 0) {
              alert('ğŸ‰ å¤ªæ£’äº†ï¼å½“å‰æ²¡æœ‰éœ€è¦å¤ä¹ çš„å•è¯ï¼');
              return;
            }
            
            document.getElementById('reviewCard').classList.remove('hidden');
            this.showCard(this.cards[0]);
          }
        } catch (error) {
          alert('è·å–å¤ä¹ å•è¯å¤±è´¥ï¼š' + error.message);
        }
      },

      // åˆ·æ–°å•è¯åˆ—è¡¨
      async refreshWords() {
        try {
          const response = await this.apiRequest('/api/sr/due?limit=20');
          if (response.success) {
            this.cards = response.data.cards;
            this.currentIndex = 0;
            alert(`âœ… å·²åˆ·æ–°ï¼å…± ${this.cards.length} ä¸ªå¾…å¤ä¹ å•è¯`);
          }
        } catch (error) {
          alert('åˆ·æ–°å¤±è´¥ï¼š' + error.message);
        }
      },

      // æ˜¾ç¤ºå¡ç‰‡
      showCard(card) {
        this.currentCard = card;
        this.reviewStartTime = Date.now();
        
        document.getElementById('wordText').textContent = card.word;
        // æ ¼å¼åŒ–éŸ³æ ‡æ˜¾ç¤ºï¼šåŠ æ–¹æ‹¬å·
        const phonetic = card.phonetic ? `/${card.phonetic}/` : '';
        document.getElementById('phoneticText').textContent = phonetic;
        document.getElementById('translationText').textContent = card.translation;
        
        // æ˜¾ç¤ºä¾‹å¥
        if (card.contexts && card.contexts.length > 0) {
          document.getElementById('contextText').textContent = card.contexts[0].sentence;
        } else {
          document.getElementById('contextText').textContent = '';
        }
        
        // é‡ç½®ç¿»è½¬çŠ¶æ€
        document.getElementById('flipCard').classList.remove('flipped');
        
        // æ›´æ–°è¿›åº¦
        this.showMessage('reviewMessage', 'info', 
          `è¿›åº¦: ${this.currentIndex + 1}/${this.cards.length} | FSRSçŠ¶æ€: ${this.getStateName(card.fsrs.state)}`);
      },

      // ç¿»è½¬å¡ç‰‡
      flipCard() {
        document.getElementById('flipCard').classList.toggle('flipped');
      },

      // æäº¤è¯„åˆ†
      async submitGrade(grade) {
        if (!this.currentCard) return;
        
        const word = this.currentCard.word;
        const duration = Math.floor((Date.now() - this.reviewStartTime) / 1000);
        
        try {
          const response = await this.apiRequest('/api/sr/review', {
            method: 'POST',
            body: JSON.stringify({ word, grade, duration_seconds: duration })
          });
          
          if (response.success) {
            const result = response.data.result;
            const nextInterval = result.next_interval_days;
            
            this.showMessage('reviewMessage', 'success', 
              `âœ“ å·²è®°å½•ï¼ä¸‹æ¬¡å¤ä¹ : ${nextInterval.toFixed(1)}å¤©å`);
            
            // å»¶è¿Ÿæ˜¾ç¤ºä¸‹ä¸€å¼ å¡ç‰‡
            setTimeout(() => {
              this.nextCard();
            }, 1000);
          }
        } catch (error) {
          this.showMessage('reviewMessage', 'error', 'æäº¤å¤±è´¥ï¼š' + error.message);
        }
      },

      // ä¸‹ä¸€å¼ å¡ç‰‡
      nextCard() {
        this.currentIndex++;
        
        if (this.currentIndex >= this.cards.length) {
          // å¤ä¹ å®Œæˆ
          document.getElementById('reviewCard').classList.add('hidden');
          alert('ğŸ‰ æœ¬è½®å¤ä¹ å®Œæˆï¼');
          this.loadStats();
        } else {
          this.showCard(this.cards[this.currentIndex]);
        }
      },

      // APIè¯·æ±‚å°è£…
      async apiRequest(endpoint, options = {}) {
        const url = `${this.apiUrl}${endpoint}`;
        const config = {
          ...options,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${this.token}`,
            ...options.headers
          }
        };
        
        const response = await fetch(url, config);
        return await response.json();
      },

      // æ˜¾ç¤ºæ¶ˆæ¯
      showMessage(elementId, type, message) {
        const element = document.getElementById(elementId);
        element.className = `message message-${type}`;
        element.textContent = message;
        element.classList.remove('hidden');
      },

      // è·å–çŠ¶æ€åç§°
      getStateName(state) {
        const names = ['æ–°å¡ç‰‡', 'å­¦ä¹ ä¸­', 'å¤ä¹ ä¸­', 'é‡æ–°å­¦ä¹ '];
        return names[state] || 'æœªçŸ¥';
      }
    };

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      app.init();
    });
  </script>
</body>
</html>

