<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Spooky Vocab - å¤ä¹ ç³»ç»Ÿ</title>
  <!-- å¼•å…¥ Auth SDK (ES Module) -->
  <script type="module">
    import { loginView } from 'https://kuroneko.chat/sdk/login.js';
    window.KuronekoAuth = { loginView };
    window.dispatchEvent(new Event('sdk-loaded'));
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
      font-size: 14px;
    }

    .card {
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .login-view, .main-view {
      display: none;
    }

    .login-view.active, .main-view.active {
      display: block;
    }

    .sdk-login-container {
      min-height: 300px;
    }

    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #f5f5f5;
      color: #666;
      margin-top: 10px;
    }

    .btn-danger {
      background: #f44336;
      color: white;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-item {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 14px;
      color: #666;
    }

    .flip-card {
      perspective: 1000px;
      height: 300px;
      margin-bottom: 20px;
    }

    .flip-card-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }

    .flip-card.flipped .flip-card-inner {
      transform: rotateY(180deg);
    }

    .flip-card-front, .flip-card-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 20px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 30px;
    }

    .flip-card-front {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .flip-card-back {
      background: white;
      border: 3px solid #667eea;
      transform: rotateY(180deg);
    }

    .word-text {
      font-size: 48px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .phonetic-text {
      font-size: 22px;
      color: #667eea;
      font-family: 'Lucida Sans Unicode', 'Times New Roman', serif;
      margin-top: 10px;
    }

    .translation-text {
      font-size: 24px;
      color: #333;
      margin-bottom: 15px;
    }

    .context-text {
      font-size: 14px;
      color: #666;
      line-height: 1.6;
    }

    .grade-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .btn-grade {
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-again {
      background: #ff6b6b;
      color: white;
    }

    .btn-hard {
      background: #ffa502;
      color: white;
    }

    .btn-good {
      background: #4ecdc4;
      color: white;
    }

    .btn-easy {
      background: #95e1d3;
      color: white;
    }

    .btn-grade:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .message {
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 15px;
      font-size: 14px;
    }

    .message-success {
      background: #d4edda;
      color: #155724;
    }

    .message-error {
      background: #f8d7da;
      color: #721c24;
    }

    .message-info {
      background: #d1ecf1;
      color: #0c5460;
    }

    .hidden {
      display: none !important;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    /* å•è¯åˆ—è¡¨æ ·å¼ */
    .word-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .word-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      transition: background 0.2s;
    }

    .word-item:hover {
      background: #f8f9fa;
    }

    .word-item:last-child {
      border-bottom: none;
    }

    .word-item-info {
      flex: 1;
    }

    .word-item-word {
      font-weight: 600;
      font-size: 16px;
      color: #333;
    }

    .word-item-meta {
      font-size: 12px;
      color: #999;
      margin-top: 4px;
    }

    .word-item-state {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      margin-right: 8px;
    }

    .state-0 { background: #e3f2fd; color: #1976d2; }
    .state-1 { background: #fff3e0; color: #f57c00; }
    .state-2 { background: #e8f5e9; color: #388e3c; }
    .state-3 { background: #ffebee; color: #d32f2f; }

    .word-item-actions {
      display: flex;
      gap: 8px;
    }

    .btn-icon {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .btn-icon-delete {
      background: #ffebee;
      color: #d32f2f;
    }

    .btn-icon-delete:hover {
      background: #ffcdd2;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .tab-btn {
      flex: 1;
      padding: 12px;
      border: 2px solid #667eea;
      background: white;
      color: #667eea;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .tab-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: transparent;
    }

    .pagination {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
    }

    .pagination button {
      padding: 8px 16px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 6px;
      cursor: pointer;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination span {
      padding: 8px 16px;
      color: #666;
    }

    .user-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-info span:first-child {
      font-size: 20px;
    }

    .user-info .username {
      color: #333;
      font-weight: 500;
    }

    .logout-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .logout-btn:hover {
      background: #d32f2f;
    }

    @media (max-width: 600px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .word-text {
        font-size: 36px;
      }
      
      .translation-text {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ‘» Spooky Vocab</h1>
      <p>æ™ºèƒ½è‹±è¯­å•è¯å¤ä¹ ç³»ç»Ÿ | FSRSç®—æ³•é©±åŠ¨</p>
    </div>

    <!-- ç™»å½•è§†å›¾ -->
    <div class="login-view active" id="loginView">
      <div class="card">
        <h2 style="margin-bottom: 20px; color: #333; text-align: center;">ç™»å½•</h2>
        <div id="sdkLoginContainer" class="sdk-login-container">
          <!-- SDK ç™»å½•è¡¨å•å°†æ¸²æŸ“åœ¨è¿™é‡Œ -->
        </div>
        <div id="loginMessage"></div>
      </div>
    </div>

    <!-- ä¸»è§†å›¾ -->
    <div class="main-view" id="mainView">
      <!-- ç”¨æˆ·ä¿¡æ¯æ  -->
      <div class="card" style="padding: 15px 20px; margin-bottom: 15px;">
        <div class="user-bar">
          <div class="user-info">
            <span>ğŸ‘¤</span>
            <span class="username" id="currentUserDisplay">-</span>
          </div>
          <button class="logout-btn" onclick="app.logout()">é€€å‡ºç™»å½•</button>
        </div>
      </div>

      <!-- ç»Ÿè®¡å¡ç‰‡ -->
      <div class="card">
        <h3 style="margin-bottom: 20px; color: #333;">å­¦ä¹ ç»Ÿè®¡</h3>
        <div class="stats-grid">
          <div class="stat-item">
            <div class="stat-value" id="statDueToday">-</div>
            <div class="stat-label">ä»Šæ—¥å¾…å¤ä¹ </div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="statCompleted">-</div>
            <div class="stat-label">ä»Šæ—¥å·²å®Œæˆ</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="statTotal">-</div>
            <div class="stat-label">æ€»è¯æ±‡é‡</div>
          </div>
          <div class="stat-item">
            <div class="stat-value" id="statStreak">-</div>
            <div class="stat-label">è¿ç»­å­¦ä¹ å¤©æ•°</div>
          </div>
        </div>
        <button class="btn btn-primary" onclick="app.startReview()">å¼€å§‹å¤ä¹ </button>
        <button class="btn btn-secondary" onclick="app.showWordList()">ğŸ“š æŸ¥çœ‹å…¨éƒ¨å•è¯</button>
        <button class="btn btn-secondary" onclick="app.loadStats()" style="margin-top: 10px;">ğŸ”„ åˆ·æ–°ç»Ÿè®¡</button>
      </div>

      <!-- å•è¯åˆ—è¡¨å¡ç‰‡ -->
      <div class="card hidden" id="wordListCard">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h3 style="color: #333;">ğŸ“š å•è¯åˆ—è¡¨</h3>
          <button class="btn-icon" onclick="app.hideWordList()" style="background: #f5f5f5;">âœ•</button>
        </div>
        
        <div class="tabs">
          <button class="tab-btn active" data-state="" onclick="app.filterWordList(this, '')">å…¨éƒ¨</button>
          <button class="tab-btn" data-state="0" onclick="app.filterWordList(this, 0)">æ–°</button>
          <button class="tab-btn" data-state="1" onclick="app.filterWordList(this, 1)">å­¦ä¹ ä¸­</button>
          <button class="tab-btn" data-state="2" onclick="app.filterWordList(this, 2)">å¤ä¹ </button>
        </div>
        
        <div id="wordListLoading" class="loading">åŠ è½½ä¸­...</div>
        <div id="wordListEmpty" class="empty-state hidden">
          <div class="empty-state-icon">ğŸ“­</div>
          <p>æš‚æ— å•è¯</p>
        </div>
        <div id="wordListContent" class="word-list hidden"></div>
        
        <div class="pagination" id="wordListPagination">
          <button onclick="app.prevPage()">ä¸Šä¸€é¡µ</button>
          <span id="pageInfo">1 / 1</span>
          <button onclick="app.nextPage()">ä¸‹ä¸€é¡µ</button>
        </div>
      </div>

      <!-- å¤ä¹ å¡ç‰‡ -->
      <div class="card hidden" id="reviewCard">
        <div id="reviewMessage"></div>
        
        <div class="flip-card" id="flipCard" onclick="app.flipCard()">
          <div class="flip-card-inner">
            <div class="flip-card-front">
              <div class="word-text" id="wordText">-</div>
              <div class="phonetic-text" id="phoneticText">-</div>
              <p style="margin-top: 20px; opacity: 0.8; font-size: 14px;">ç‚¹å‡»ç¿»è½¬æŸ¥çœ‹é‡Šä¹‰</p>
            </div>
            <div class="flip-card-back">
              <div class="translation-text" id="translationText">-</div>
              <div class="context-text" id="contextText">-</div>
            </div>
          </div>
        </div>

        <div class="grade-buttons">
          <button class="btn-grade btn-again" onclick="app.submitGrade(1)">
            ğŸ˜° Again<br><small>å®Œå…¨ä¸è®°å¾—</small>
          </button>
          <button class="btn-grade btn-hard" onclick="app.submitGrade(2)">
            ğŸ˜“ Hard<br><small>å¾ˆéš¾æƒ³èµ·</small>
          </button>
          <button class="btn-grade btn-good" onclick="app.submitGrade(3)">
            ğŸ˜Š Good<br><small>æ­£å¸¸è®°èµ·</small>
          </button>
          <button class="btn-grade btn-easy" onclick="app.submitGrade(4)">
            ğŸ˜ Easy<br><small>è½»æ¾è®°èµ·</small>
          </button>
        </div>
        
        <div style="margin-top: 15px; display: flex; gap: 10px;">
          <button class="btn btn-secondary" onclick="app.deleteCurrentWord()" style="flex: 1; background: #ffebee; color: #d32f2f;">
            ğŸ—‘ï¸ åˆ é™¤æ­¤å•è¯
          </button>
          <button class="btn btn-secondary" onclick="app.skipCard()" style="flex: 1;">
            â­ï¸ è·³è¿‡
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const app = {
      // é…ç½®
      apiUrl: 'https://kuroneko.chat/vocab-api',
      authUrl: 'https://kuroneko.chat',
      
      // çŠ¶æ€
      token: '',
      userInfo: null,
      currentCard: null,
      cards: [],
      currentIndex: 0,
      reviewStartTime: null,
      loginInstance: null,
      
      // å•è¯åˆ—è¡¨çŠ¶æ€
      wordListData: [],
      wordListPage: 0,
      wordListLimit: 30,
      wordListTotal: 0,
      wordListStateFilter: '',

      // ============ åˆå§‹åŒ– ============
      
      init() {
        console.log('[Review] Initializing...');
        
        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ï¼ˆä½¿ç”¨ refresh_tokenï¼‰
        const savedToken = localStorage.getItem('refresh_token') || localStorage.getItem('token');
        const savedUserInfo = localStorage.getItem('user_info');
        
        if (savedToken && savedUserInfo) {
          this.token = savedToken;
          try {
            this.userInfo = JSON.parse(savedUserInfo);
          } catch (e) {
            this.userInfo = null;
          }
          
          // éªŒè¯ token æœ‰æ•ˆæ€§
          this.validateToken().then(valid => {
            if (valid) {
              this.showMainView();
            } else {
              this.showLoginView();
            }
          });
        } else {
          this.showLoginView();
        }
      },

      // éªŒè¯ token æ˜¯å¦æœ‰æ•ˆ
      async validateToken() {
        try {
          const response = await fetch(`${this.apiUrl}/api/user/info`, {
            headers: {
              'Authorization': `Bearer ${this.token}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            if (data.success) {
              console.log('[Review] Token valid, user:', data.data);
              return true;
            }
          }
          
          console.log('[Review] Token invalid');
          return false;
        } catch (error) {
          console.error('[Review] Token validation error:', error);
          return false;
        }
      },

      // ============ è§†å›¾åˆ‡æ¢ ============

      showLoginView() {
        document.getElementById('loginView').classList.add('active');
        document.getElementById('mainView').classList.remove('active');
        this.initSDKLogin();
      },

      showMainView() {
        document.getElementById('loginView').classList.remove('active');
        document.getElementById('mainView').classList.add('active');
        
        // æ˜¾ç¤ºç”¨æˆ·å
        const displayName = this.userInfo?.username || this.userInfo?.user_id || 'ç”¨æˆ·';
        document.getElementById('currentUserDisplay').textContent = displayName;
        
        // åŠ è½½ç»Ÿè®¡
        this.loadStats();
      },

      // ============ SDK ç™»å½• ============

      initSDKLogin() {
        console.log('[Review] Initializing SDK login...');
        
        // æ£€æŸ¥ SDK æ˜¯å¦å·²åŠ è½½
        if (!window.KuronekoAuth || !window.KuronekoAuth.loginView) {
          console.error('[Review] Auth SDK not loaded');
          this.showMessage('loginMessage', 'error', 'ç™»å½•ç»„ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
          
          // é™çº§æ–¹æ¡ˆ
          document.getElementById('sdkLoginContainer').innerHTML = `
            <div style="text-align: center; padding: 20px;">
              <p style="color: #666; margin-bottom: 16px;">ç™»å½•ç»„ä»¶åŠ è½½å¤±è´¥</p>
              <a href="${this.authUrl}/login?redirect=${encodeURIComponent(window.location.href)}" 
                 style="color: #667eea; text-decoration: none;">
                ç‚¹å‡»è¿™é‡Œå‰å¾€ç™»å½•é¡µé¢ â†’
              </a>
            </div>
          `;
          return;
        }

        const { loginView } = window.KuronekoAuth;

        // åˆ›å»ºç™»å½•å®ä¾‹
        this.loginInstance = loginView.create({
          container: document.getElementById('sdkLoginContainer'),
          title: 'ç™»å½•',
          theme: 'light',
          apiUrl: this.authUrl
        });

        // ç™»å½•æˆåŠŸå›è°ƒ
        this.loginInstance.onSuccess((result) => {
          console.log('[Review] Login success:', result);
          
          // â˜… ä¼˜å…ˆä½¿ç”¨ refresh tokenï¼ˆé•¿æœŸæœ‰æ•ˆï¼‰
          const tokenToUse = result.refreshToken || result.token;
          console.log('[Review] Using token type:', result.refreshToken ? 'refresh_token (long-term)' : 'access_token (short-term)');
          
          this.token = tokenToUse;
          
          // ä¿å­˜åˆ° localStorage
          localStorage.setItem('token', tokenToUse);
          if (result.refreshToken) {
            localStorage.setItem('refresh_token', result.refreshToken);
          }
          if (result.token) {
            localStorage.setItem('access_token', result.token);
          }
          
          // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
          if (result.user) {
            this.userInfo = {
              user_id: result.user.id,
              username: result.user.username,
              email: result.user.email
            };
            localStorage.setItem('user_info', JSON.stringify(this.userInfo));
          }
          
          this.showMainView();
        });

        // ç™»å½•å¤±è´¥å›è°ƒ
        this.loginInstance.onError((error) => {
          console.error('[Review] Login error:', error);
          this.showMessage('loginMessage', 'error', `ç™»å½•å¤±è´¥: ${error.message || 'æœªçŸ¥é”™è¯¯'}`);
        });

        // æŒ‚è½½ç™»å½•è¡¨å•
        this.loginInstance.mount();
        console.log('[Review] SDK login form mounted');
      },

      // ============ é€€å‡ºç™»å½• ============

      logout() {
        if (!confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) return;
        
        // æ¸…é™¤æ‰€æœ‰å­˜å‚¨
        localStorage.removeItem('token');
        localStorage.removeItem('refresh_token');
        localStorage.removeItem('access_token');
        localStorage.removeItem('user_info');
        
        this.token = '';
        this.userInfo = null;
        this.loginInstance = null;
        
        // æ¸…ç©º SDK å®¹å™¨
        document.getElementById('sdkLoginContainer').innerHTML = '';
        
        // æ˜¾ç¤ºç™»å½•è§†å›¾
        this.showLoginView();
      },

      // ============ ç»Ÿè®¡ä¸å¤ä¹  ============

      async loadStats() {
        try {
          const response = await this.apiRequest('/api/sr/stats');
          
          if (response.success) {
            const stats = response.data;
            document.getElementById('statDueToday').textContent = stats.overview.due_today;
            document.getElementById('statCompleted').textContent = stats.overview.completed_today;
            document.getElementById('statTotal').textContent = stats.overview.total_cards;
            document.getElementById('statStreak').textContent = stats.activity.study_streak_days;
          }
        } catch (error) {
          console.error('[Review] Load stats failed:', error);
        }
      },

      async startReview() {
        try {
          const response = await this.apiRequest('/api/sr/due?limit=20');
          
          if (response.success) {
            this.cards = response.data.cards;
            this.currentIndex = 0;
            
            if (this.cards.length === 0) {
              alert('ğŸ‰ å¤ªæ£’äº†ï¼å½“å‰æ²¡æœ‰éœ€è¦å¤ä¹ çš„å•è¯ï¼');
              return;
            }
            
            document.getElementById('reviewCard').classList.remove('hidden');
            this.showCard(this.cards[0]);
          }
        } catch (error) {
          alert('è·å–å¤ä¹ å•è¯å¤±è´¥ï¼š' + error.message);
        }
      },

      async refreshWords() {
        try {
          const response = await this.apiRequest('/api/sr/due?limit=20');
          if (response.success) {
            this.cards = response.data.cards;
            this.currentIndex = 0;
            alert(`âœ… å·²åˆ·æ–°ï¼å…± ${this.cards.length} ä¸ªå¾…å¤ä¹ å•è¯`);
          }
        } catch (error) {
          alert('åˆ·æ–°å¤±è´¥ï¼š' + error.message);
        }
      },

      showCard(card) {
        this.currentCard = card;
        this.reviewStartTime = Date.now();
        
        document.getElementById('wordText').textContent = card.word;
        const phonetic = card.phonetic ? `/${card.phonetic}/` : '';
        document.getElementById('phoneticText').textContent = phonetic;
        document.getElementById('translationText').textContent = card.translation;
        
        if (card.contexts && card.contexts.length > 0) {
          document.getElementById('contextText').textContent = card.contexts[0].sentence;
        } else {
          document.getElementById('contextText').textContent = '';
        }
        
        document.getElementById('flipCard').classList.remove('flipped');
        
        this.showMessage('reviewMessage', 'info', 
          `è¿›åº¦: ${this.currentIndex + 1}/${this.cards.length} | FSRSçŠ¶æ€: ${this.getStateName(card.fsrs.state)}`);
      },

      flipCard() {
        document.getElementById('flipCard').classList.toggle('flipped');
      },

      async submitGrade(grade) {
        if (!this.currentCard) return;
        
        const word = this.currentCard.word;
        const duration = Math.floor((Date.now() - this.reviewStartTime) / 1000);
        
        try {
          const response = await this.apiRequest('/api/sr/review', {
            method: 'POST',
            body: JSON.stringify({ word, grade, duration_seconds: duration })
          });
          
          if (response.success) {
            const result = response.data.result;
            const nextInterval = result.next_interval_days;
            
            this.showMessage('reviewMessage', 'success', 
              `âœ“ å·²è®°å½•ï¼ä¸‹æ¬¡å¤ä¹ : ${nextInterval.toFixed(1)}å¤©å`);
            
            setTimeout(() => {
              this.nextCard();
            }, 1000);
          }
        } catch (error) {
          this.showMessage('reviewMessage', 'error', 'æäº¤å¤±è´¥ï¼š' + error.message);
        }
      },

      nextCard() {
        this.currentIndex++;
        
        if (this.currentIndex >= this.cards.length) {
          document.getElementById('reviewCard').classList.add('hidden');
          alert('ğŸ‰ æœ¬è½®å¤ä¹ å®Œæˆï¼');
          this.loadStats();
        } else {
          this.showCard(this.cards[this.currentIndex]);
        }
      },

      skipCard() {
        // å°†å½“å‰å¡ç‰‡ç§»åˆ°é˜Ÿåˆ—æœ«å°¾
        if (this.currentCard && this.cards.length > 1) {
          const skipped = this.cards.splice(this.currentIndex, 1)[0];
          this.cards.push(skipped);
          
          // æ˜¾ç¤ºä¸‹ä¸€å¼ ï¼ˆç´¢å¼•ä¸å˜ï¼Œå› ä¸ºæ•°ç»„å·²ç»å˜äº†ï¼‰
          if (this.currentIndex >= this.cards.length) {
            this.currentIndex = 0;
          }
          this.showCard(this.cards[this.currentIndex]);
        }
      },

      async deleteCurrentWord() {
        if (!this.currentCard) return;
        
        const word = this.currentCard.word;
        await this.deleteWord(word);
        
        // å¦‚æœè¿˜æœ‰å¡ç‰‡ï¼Œæ˜¾ç¤ºä¸‹ä¸€å¼ 
        if (this.cards.length > 0) {
          if (this.currentIndex >= this.cards.length) {
            this.currentIndex = this.cards.length - 1;
          }
          this.showCard(this.cards[this.currentIndex]);
        } else {
          document.getElementById('reviewCard').classList.add('hidden');
          alert('ğŸ‰ æ‰€æœ‰å•è¯å·²å¤„ç†å®Œæˆï¼');
        }
      },

      // ============ å•è¯åˆ—è¡¨ ============

      async showWordList() {
        document.getElementById('wordListCard').classList.remove('hidden');
        document.getElementById('reviewCard').classList.add('hidden');
        this.wordListPage = 0;
        this.wordListStateFilter = '';
        await this.loadWordList();
      },

      hideWordList() {
        document.getElementById('wordListCard').classList.add('hidden');
      },

      async loadWordList() {
        const loadingEl = document.getElementById('wordListLoading');
        const emptyEl = document.getElementById('wordListEmpty');
        const contentEl = document.getElementById('wordListContent');
        
        loadingEl.classList.remove('hidden');
        emptyEl.classList.add('hidden');
        contentEl.classList.add('hidden');

        try {
          const offset = this.wordListPage * this.wordListLimit;
          let url = `/api/sr/words?limit=${this.wordListLimit}&offset=${offset}&sort=created_at&order=desc`;
          
          if (this.wordListStateFilter !== '') {
            url += `&state=${this.wordListStateFilter}`;
          }
          
          const response = await this.apiRequest(url);
          
          if (response.success) {
            this.wordListData = response.data.words;
            this.wordListTotal = response.data.pagination.total;
            
            loadingEl.classList.add('hidden');
            
            if (this.wordListData.length === 0) {
              emptyEl.classList.remove('hidden');
            } else {
              contentEl.classList.remove('hidden');
              this.renderWordList();
            }
            
            this.updatePagination();
          }
        } catch (error) {
          loadingEl.classList.add('hidden');
          alert('åŠ è½½å•è¯åˆ—è¡¨å¤±è´¥ï¼š' + error.message);
        }
      },

      renderWordList() {
        const contentEl = document.getElementById('wordListContent');
        
        contentEl.innerHTML = this.wordListData.map(word => `
          <div class="word-item" data-word="${word.word}">
            <div class="word-item-info">
              <div class="word-item-word">${word.word}</div>
              <div class="word-item-meta">
                <span class="word-item-state state-${word.state}">${word.state_name}</span>
                å¤ä¹  ${word.reps} æ¬¡ | 
                ${word.is_due ? 'ğŸ”´ å¾…å¤ä¹ ' : 'â° ' + this.formatDueDate(word.due_date)}
              </div>
            </div>
            <div class="word-item-actions">
              <button class="btn-icon btn-icon-delete" onclick="app.deleteWord('${word.word}')" title="åˆ é™¤å•è¯">ğŸ—‘ï¸</button>
            </div>
          </div>
        `).join('');
      },

      formatDueDate(dueDate) {
        if (!dueDate) return 'æœªå®‰æ’';
        const date = new Date(dueDate);
        const now = new Date();
        const diffDays = Math.ceil((date - now) / (1000 * 60 * 60 * 24));
        
        if (diffDays <= 0) return 'ä»Šå¤©';
        if (diffDays === 1) return 'æ˜å¤©';
        if (diffDays <= 7) return `${diffDays}å¤©å`;
        return date.toLocaleDateString('zh-CN');
      },

      updatePagination() {
        const totalPages = Math.ceil(this.wordListTotal / this.wordListLimit);
        const currentPage = this.wordListPage + 1;
        
        document.getElementById('pageInfo').textContent = `${currentPage} / ${totalPages || 1}`;
        
        const pagination = document.getElementById('wordListPagination');
        const buttons = pagination.querySelectorAll('button');
        buttons[0].disabled = this.wordListPage === 0;
        buttons[1].disabled = this.wordListPage >= totalPages - 1;
      },

      async prevPage() {
        if (this.wordListPage > 0) {
          this.wordListPage--;
          await this.loadWordList();
        }
      },

      async nextPage() {
        const totalPages = Math.ceil(this.wordListTotal / this.wordListLimit);
        if (this.wordListPage < totalPages - 1) {
          this.wordListPage++;
          await this.loadWordList();
        }
      },

      async filterWordList(btn, state) {
        // æ›´æ–° tab æ ·å¼
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        this.wordListStateFilter = state;
        this.wordListPage = 0;
        await this.loadWordList();
      },

      async deleteWord(word) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤å•è¯ "${word}" å—ï¼Ÿ\n\nåˆ é™¤åå°†æ— æ³•æ¢å¤ï¼ŒåŒ…æ‹¬æ‰€æœ‰å¤ä¹ è®°å½•ã€‚`)) {
          return;
        }

        try {
          const response = await this.apiRequest(`/api/sr/words/${encodeURIComponent(word)}`, {
            method: 'DELETE'
          });

          if (response.success) {
            alert(`âœ… å·²åˆ é™¤å•è¯: ${word}`);
            
            // ä»å½“å‰åˆ—è¡¨ä¸­ç§»é™¤
            this.wordListData = this.wordListData.filter(w => w.word !== word);
            this.wordListTotal--;
            
            // å¦‚æœå½“å‰å¤ä¹ çš„å°±æ˜¯è¿™ä¸ªè¯ï¼Œè·³åˆ°ä¸‹ä¸€ä¸ª
            if (this.currentCard && this.currentCard.word === word) {
              this.cards = this.cards.filter(c => c.word !== word);
              if (this.currentIndex >= this.cards.length) {
                this.currentIndex = this.cards.length - 1;
              }
              if (this.cards.length > 0) {
                this.showCard(this.cards[this.currentIndex]);
              } else {
                document.getElementById('reviewCard').classList.add('hidden');
              }
            }
            
            // é‡æ–°æ¸²æŸ“åˆ—è¡¨
            if (this.wordListData.length === 0 && this.wordListPage > 0) {
              this.wordListPage--;
              await this.loadWordList();
            } else if (this.wordListData.length === 0) {
              document.getElementById('wordListContent').classList.add('hidden');
              document.getElementById('wordListEmpty').classList.remove('hidden');
            } else {
              this.renderWordList();
            }
            
            this.updatePagination();
            this.loadStats();
          }
        } catch (error) {
          alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
        }
      },

      // ============ è¾…åŠ©æ–¹æ³• ============

      async apiRequest(endpoint, options = {}) {
        const url = `${this.apiUrl}${endpoint}`;
        const config = {
          ...options,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${this.token}`,
            ...options.headers
          }
        };
        
        const response = await fetch(url, config);
        const data = await response.json();
        
        // å¦‚æœ token æ— æ•ˆï¼Œè·³è½¬åˆ°ç™»å½•
        if (response.status === 401) {
          console.log('[Review] Token expired, redirecting to login...');
          this.logout();
          throw new Error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
        }
        
        return data;
      },

      showMessage(elementId, type, message) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        element.className = `message message-${type}`;
        element.textContent = message;
        element.classList.remove('hidden');
        
        if (type === 'error') {
          setTimeout(() => {
            element.className = 'message';
            element.textContent = '';
          }, 5000);
        }
      },

      getStateName(state) {
        const names = ['æ–°å¡ç‰‡', 'å­¦ä¹ ä¸­', 'å¤ä¹ ä¸­', 'é‡æ–°å­¦ä¹ '];
        return names[state] || 'æœªçŸ¥';
      }
    };

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', () => {
      // æ£€æŸ¥ URL å‚æ•°ä¸­æ˜¯å¦æœ‰ tokenï¼ˆä»ç™»å½•é¡µå›è°ƒï¼‰
      const urlParams = new URLSearchParams(window.location.search);
      const tokenFromUrl = urlParams.get('token');
      
      if (tokenFromUrl) {
        console.log('[Review] Token from URL callback');
        localStorage.setItem('token', tokenFromUrl);
        // æ¸…é™¤ URL å‚æ•°
        window.history.replaceState({}, document.title, window.location.pathname);
      }
      
      // ç­‰å¾… SDK åŠ è½½å®Œæˆï¼ˆES Module æ˜¯å¼‚æ­¥çš„ï¼‰
      if (window.KuronekoAuth) {
        app.init();
      } else {
        window.addEventListener('sdk-loaded', () => {
          console.log('[Review] SDK loaded event received');
          app.init();
        });
        // è¶…æ—¶å¤„ç†ï¼šå¦‚æœ SDK åŠ è½½å¤±è´¥ï¼Œä»ç„¶åˆå§‹åŒ–ï¼ˆä¼šæ˜¾ç¤ºé™çº§æ–¹æ¡ˆï¼‰
        setTimeout(() => {
          if (!window.KuronekoAuth) {
            console.log('[Review] SDK load timeout, initializing anyway');
            app.init();
          }
        }, 3000);
      }
    });
  </script>
</body>
</html>
