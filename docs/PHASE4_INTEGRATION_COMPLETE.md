# ðŸŽ‰ é˜¶æ®µå››ï¼šå‰åŽç«¯é›†æˆå®Œæˆ

## ðŸ“… å®Œæˆæ—¶é—´
2025-11-30

## âœ… å®žçŽ°å†…å®¹

### ðŸ” åŽç«¯JWTè®¤è¯ç³»ç»Ÿ

#### 1. JWTä¸­é—´ä»¶ (`backend/src/middleware/auth.js`)
- âœ… JWT tokenéªŒè¯
- âœ… Tokenè¿‡æœŸæ£€æŸ¥
- âœ… é”™è¯¯å¤„ç†ï¼ˆTOKEN_EXPIRED, INVALID_TOKENç­‰ï¼‰
- âœ… ç”¨æˆ·ä¿¡æ¯æå–ï¼ˆuser_id, CEFRç­‰çº§ï¼‰

#### 2. è®¤è¯è·¯ç”± (`backend/src/routes/auth.js`)
- âœ… `POST /api/auth/test-token` - ç”Ÿæˆæµ‹è¯•tokenï¼ˆå¼€å‘ç”¨ï¼‰
- âœ… `POST /api/auth/refresh` - åˆ·æ–°token
- âœ… `GET /api/auth/verify` - éªŒè¯tokenæœ‰æ•ˆæ€§

#### 3. æ•°æ®åº“æ›´æ–°
- âœ… ä»Ž `better-sqlite3` è¿ç§»åˆ° `sqlite3` ï¼ˆNode.js v24å…¼å®¹ï¼‰
- âœ… å¼‚æ­¥APIå°è£… (dbRun, dbGet, dbAll)
- âœ… æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬æ›´æ–°

### ðŸŽ¨ å‰ç«¯é›†æˆ

#### 1. é…ç½®ç®¡ç† (`extension/config.js`)
```javascript
- APIæœåŠ¡å™¨é…ç½®
- JWTå­˜å‚¨é…ç½®
- åŠŸèƒ½å¼€å…³ï¼ˆAPIæ¨¡å¼/ç¦»çº¿æ¨¡å¼ï¼‰
- æ€§èƒ½å‚æ•°ï¼ˆæ‰¹é‡å¤§å°ã€ç¼“å­˜æ—¶é—´ç­‰ï¼‰
```

#### 2. JWTç®¡ç†å™¨ (`extension/content/jwt-manager.js`)
- âœ… Tokenå­˜å‚¨å’ŒåŠ è½½
- âœ… JWTè§£æžï¼ˆBase64è§£ç ï¼‰
- âœ… Tokenæœ‰æ•ˆæ€§æ£€æŸ¥
- âœ… è‡ªåŠ¨åˆ·æ–°æ£€æµ‹
- âœ… èŽ·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆuser_id, CEFR levelï¼‰

#### 3. APIå®¢æˆ·ç«¯ (`extension/content/api-client.js`)
**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- âœ… HTTPè¯·æ±‚å°è£…ï¼ˆGET/POST/PUT/DELETEï¼‰
- âœ… è‡ªåŠ¨æ·»åŠ JWT Authorization header
- âœ… Tokenè¿‡æœŸè‡ªåŠ¨åˆ·æ–°
- âœ… è¯·æ±‚è¶…æ—¶å’Œé‡è¯•æœºåˆ¶
- âœ… æ‰¹é‡è¯·æ±‚ä¼˜åŒ–

**APIæ–¹æ³•ï¼š**
```javascript
// è®¤è¯
- getTestToken(userId, cefrLevel)
- refreshToken()
- verifyToken()

// è¯æ±‡
- batchCheckWords(words)
- getWord(word)

// åé¦ˆ
- markWordKnown(word)
- markWordUnknown(word, context, url)
- recordEncounter(word)

// å¤ä¹ 
- getReviewWords(limit, offset, sort)
- getWordContexts(word, limit)
- getStats(period)

// ç”¨æˆ·
- getUserSettings()
- updateUserSettings(settings)
- getUserProfile()
```

#### 4. ä¸»å…¥å£æ›´æ–° (`extension/content/main.js`)
- âœ… JWTç®¡ç†å™¨åˆå§‹åŒ–
- âœ… è‡ªåŠ¨èŽ·å–æµ‹è¯•token
- âœ… Tokenåˆ·æ–°æ£€æµ‹
- âœ… APIå¤±è´¥é™çº§åˆ°Mockæ¨¡å¼
- âœ… ç”¨æˆ·IDç®¡ç†

#### 5. æ–‡æœ¬å¤„ç†å™¨å‡çº§ (`extension/content/text-processor.js`)
**APIé›†æˆï¼š**
- âœ… è¯æ±‡åˆ¤æ–­ç»“æžœç¼“å­˜
- âœ… æ‰¹é‡å•è¯æ£€æŸ¥ï¼ˆè°ƒç”¨APIï¼‰
- âœ… å¼‚æ­¥ç¿»è¯‘èŽ·å–
- âœ… APIå¤±è´¥é™çº§åˆ°Mock
- âœ… ç¼“å­˜è¿‡æœŸæ¸…ç†

**æ€§èƒ½ä¼˜åŒ–ï¼š**
- æ‰¹é‡è¯·æ±‚ï¼ˆä¸€æ¬¡æ£€æŸ¥å¤šä¸ªå•è¯ï¼‰
- æœ¬åœ°ç¼“å­˜ï¼ˆé¿å…é‡å¤APIè°ƒç”¨ï¼‰
- æ‡’åŠ è½½ï¼ˆæŒ‰éœ€èŽ·å–ç¿»è¯‘ï¼‰

#### 6. åé¦ˆå¤„ç†å™¨å‡çº§ (`extension/content/feedback-handler.js`)
**APIåŒæ­¥ï¼š**
- âœ… æ ‡è®°å·²çŸ¥å•è¯åŒæ­¥åˆ°API
- âœ… æ ‡è®°æœªçŸ¥å•è¯åŒæ­¥åˆ°API
- âœ… åŒæ­¥é˜Ÿåˆ—ï¼ˆç¦»çº¿æ—¶ç¼“å­˜ï¼Œä¸Šçº¿åŽåŒæ­¥ï¼‰
- âœ… æœ¬åœ°æ—¥å¿—å¤‡ä»½

**ç‰¹æ€§ï¼š**
- ä¹è§‚æ›´æ–°ï¼ˆç«‹å³æ›´æ–°UIï¼ŒåŽå°åŒæ­¥ï¼‰
- å¤±è´¥é‡è¯•
- é˜Ÿåˆ—æŒä¹…åŒ–

#### 7. Popupç•Œé¢å‡çº§ (`extension/popup/popup.js`)
**APIæ•°æ®å±•ç¤ºï¼š**
- âœ… ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤ºï¼ˆuser_id, CEFRç­‰çº§ï¼‰
- âœ… å®žæ—¶ç»Ÿè®¡æ•°æ®ï¼ˆä»ŽAPIèŽ·å–ï¼‰
- âœ… å¤ä¹ å•è¯åˆ—è¡¨ï¼ˆä»ŽAPIèŽ·å–ï¼‰
- âœ… CEFRç­‰çº§æ›´æ–°ï¼ˆåŒæ­¥åˆ°APIï¼‰
- âœ… è¿žæŽ¥çŠ¶æ€æ˜¾ç¤º

**é™çº§æ”¯æŒï¼š**
- APIä¸å¯ç”¨æ—¶è‡ªåŠ¨åˆ‡æ¢åˆ°æœ¬åœ°æ•°æ®
- æ˜¾ç¤ºå½“å‰æ¨¡å¼ï¼ˆAPIæ¨¡å¼/ç¦»çº¿æ¨¡å¼ï¼‰

## ðŸ”„ å·¥ä½œæµç¨‹

### åˆå§‹åŒ–æµç¨‹
```
1. é¡µé¢åŠ è½½
   â†“
2. åŠ è½½config.js
   â†“
3. åˆå§‹åŒ–JWTç®¡ç†å™¨
   â†“
4. æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆtoken
   â”œâ”€ æœ‰ â†’ æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°
   â””â”€ æ—  â†’ èŽ·å–æµ‹è¯•token
   â†“
5. åˆå§‹åŒ–å„åŠŸèƒ½æ¨¡å—
   â†“
6. å¼€å§‹å¤„ç†é¡µé¢å•è¯
```

### å•è¯å¤„ç†æµç¨‹
```
1. éåŽ†é¡µé¢æ–‡æœ¬èŠ‚ç‚¹
   â†“
2. æå–æ‰€æœ‰è‹±æ–‡å•è¯
   â†“
3. æ‰¹é‡è°ƒç”¨APIæ£€æŸ¥
   â”œâ”€ æˆåŠŸ â†’ ç¼“å­˜ç»“æžœ
   â””â”€ å¤±è´¥ â†’ é™çº§åˆ°Mock
   â†“
4. æ ¹æ®ç»“æžœæ ‡è®°å•è¯
   â†“
5. æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
```

### åé¦ˆåŒæ­¥æµç¨‹
```
1. ç”¨æˆ·æ“ä½œï¼ˆæ ‡è®°å·²çŸ¥/æœªçŸ¥ï¼‰
   â†“
2. ç«‹å³æ›´æ–°æœ¬åœ°UI
   â†“
3. è°ƒç”¨APIåŒæ­¥
   â”œâ”€ æˆåŠŸ â†’ å®Œæˆ
   â””â”€ å¤±è´¥ â†’ åŠ å…¥åŒæ­¥é˜Ÿåˆ—
   â†“
4. å®šæœŸé‡è¯•åŒæ­¥é˜Ÿåˆ—
```

## ðŸ§ª æµ‹è¯•ç»“æžœ

### åŽç«¯æµ‹è¯•
```bash
âœ… æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ
âœ… å¥åº·æ£€æŸ¥ç«¯ç‚¹æ­£å¸¸: GET /health
âœ… JWT tokenç”ŸæˆæˆåŠŸ: POST /api/auth/test-token
âœ… JWT tokenéªŒè¯æˆåŠŸ: GET /api/auth/verify
âœ… æ•°æ®åº“åˆå§‹åŒ–æˆåŠŸ
```

### å‰ç«¯æµ‹è¯•ï¼ˆå¾…è¿›è¡Œï¼‰
- [ ] Chromeæ‰©å±•åŠ è½½
- [ ] JWTè‡ªåŠ¨èŽ·å–
- [ ] é¡µé¢å•è¯è¯†åˆ«
- [ ] APIæ‰¹é‡æŸ¥è¯¢
- [ ] ç¿»è¯‘æ˜¾ç¤º
- [ ] ç”¨æˆ·åé¦ˆåŒæ­¥
- [ ] Popupæ•°æ®æ˜¾ç¤º

## ðŸ“Š æŠ€æœ¯æž¶æž„

### è®¤è¯æµç¨‹
```
Frontend                          Backend
   |                                 |
   |--- POST /api/auth/test-token ->|
   |<-- JWT token -----------------|
   |                                 |
   |   (å­˜å‚¨åˆ°chrome.storage.local)  |
   |                                 |
   |--- GET /api/... --------------->|
   |    (Header: Authorization)      |
   |                                 |
   |<-- éªŒè¯token -------------------|
   |<-- è¿”å›žæ•°æ® --------------------|
   |                                 |
   |   (tokenå¿«è¿‡æœŸæ—¶)               |
   |--- POST /api/auth/refresh ----->|
   |<-- æ–°token ---------------------|
```

### æ•°æ®æµ
```
ç”¨æˆ·äº¤äº’
   â†“
Content Script (main.js)
   â†“
API Client (api-client.js)
   â†“
JWT Manager (jwt-manager.js)
   â†“
Backend API
   â†“
SQLite Database
```

## ðŸŽ¯ æ ¸å¿ƒç‰¹æ€§

### 1. è®¤è¯ç³»ç»Ÿ
- JWT tokenç®¡ç†
- è‡ªåŠ¨åˆ·æ–°æœºåˆ¶
- å¼€å‘æ¨¡å¼æµ‹è¯•token

### 2. ç¦»çº¿æ”¯æŒ
- æœ¬åœ°æ•°æ®ç¼“å­˜
- åŒæ­¥é˜Ÿåˆ—
- APIå¤±è´¥é™çº§

### 3. æ€§èƒ½ä¼˜åŒ–
- æ‰¹é‡è¯·æ±‚
- ç»“æžœç¼“å­˜
- æ‡’åŠ è½½

### 4. é”™è¯¯å¤„ç†
- ç½‘ç»œé”™è¯¯é‡è¯•
- Tokenè¿‡æœŸè‡ªåŠ¨åˆ·æ–°
- é™çº§åˆ°Mockæ¨¡å¼

## ðŸ“¦ ä¾èµ–åŒ…

### åŽç«¯
```json
{
  "express": "^4.18.2",
  "cors": "^2.8.5",
  "sqlite3": "^5.1.7",
  "jsonwebtoken": "^9.0.2"
}
```

### å‰ç«¯
- åŽŸç”ŸJavaScript
- Chrome Extension API
- Web Crypto API (JWTè§£æž)

## ðŸš€ ä¸‹ä¸€æ­¥

### Phase 5: å®Œæ•´åŽç«¯å®žçŽ°
- [ ] å®žçŽ°æ‰€æœ‰APIç«¯ç‚¹ï¼ˆvocabulary, feedback, review, userï¼‰
- [ ] è‡ªé€‚åº”å­¦ä¹ ç®—æ³•
- [ ] é›†æˆECDICTç¦»çº¿è¯å…¸
- [ ] æ•°æ®ç»Ÿè®¡å’Œåˆ†æž

### Phase 6: ç”Ÿäº§ä¼˜åŒ–
- [ ] çœŸå®žJWTåŠ å¯†ï¼ˆç”Ÿäº§çŽ¯å¢ƒï¼‰
- [ ] HTTPSæ”¯æŒ
- [ ] æ€§èƒ½ç›‘æŽ§
- [ ] é”™è¯¯æ—¥å¿—
- [ ] ç”¨æˆ·æ³¨å†Œ/ç™»å½•ç³»ç»Ÿ

### Phase 7: å‘å¸ƒ
- [ ] Chrome Web Storeå‘å¸ƒ
- [ ] ç”¨æˆ·æ–‡æ¡£
- [ ] éšç§æ”¿ç­–
- [ ] ä½¿ç”¨æ•™ç¨‹

## ðŸ“ Notes

### æŠ€æœ¯å†³ç­–
1. **sqlite3 vs better-sqlite3**
   - é€‰æ‹©sqlite3å› ä¸ºNode.js v24å…¼å®¹æ€§
   - è™½ç„¶æ€§èƒ½ç¨ä½Žï¼Œä½†å¯¹å½“å‰è§„æ¨¡è¶³å¤Ÿ

2. **JWTå¼€å‘æ¨¡å¼**
   - ä½¿ç”¨æ˜Žæ–‡test-tokenä¾¿äºŽå¼€å‘è°ƒè¯•
   - ç”Ÿäº§çŽ¯å¢ƒå°†ä½¿ç”¨çœŸå®žç™»å½•ç³»ç»Ÿ

3. **åŒæ¨¡å¼è¿è¡Œ**
   - APIæ¨¡å¼ï¼šè¿žæŽ¥åŽç«¯
   - Mockæ¨¡å¼ï¼šå‰ç«¯æµ‹è¯•/ç¦»çº¿ä½¿ç”¨
   - è‡ªåŠ¨é™çº§ä¿è¯ç”¨æˆ·ä½“éªŒ

### å·²çŸ¥é—®é¢˜
1. éƒ¨åˆ†åŽç«¯è·¯ç”±éœ€è¦æ›´æ–°ä¸ºasync/await
2. ECDICTè¯å…¸æ–‡ä»¶éœ€è¦å•ç‹¬ä¸‹è½½
3. ç”Ÿäº§çŽ¯å¢ƒéœ€è¦é…ç½®HTTPS

## ðŸŽ“ å­¦ä¹ è¦ç‚¹

### JWTè®¤è¯
- Tokenç”Ÿæˆå’ŒéªŒè¯
- è¿‡æœŸæ—¶é—´ç®¡ç†
- Authorization header

### Chrome Extension
- Content Scriptsé€šä¿¡
- Storage APIä½¿ç”¨
- Manifest V3é…ç½®

### å‰åŽç«¯åˆ†ç¦»
- RESTful APIè®¾è®¡
- é”™è¯¯å¤„ç†ç­–ç•¥
- çŠ¶æ€åŒæ­¥æœºåˆ¶

---

## ðŸ‘ æ€»ç»“

âœ… **Phase 4é›†æˆå®Œæˆï¼**

æˆåŠŸå®žçŽ°äº†å‰åŽç«¯å®Œæ•´é›†æˆï¼ŒJWTè®¤è¯ç³»ç»Ÿæ­£å¸¸å·¥ä½œï¼Œä¸ºåŽç»­åŠŸèƒ½å¼€å‘æ‰“ä¸‹åšå®žåŸºç¡€ã€‚

ä¸‹ä¸€é˜¶æ®µå°†å®Œæˆå‰©ä½™APIç«¯ç‚¹çš„å®žçŽ°ï¼Œå¹¶é›†æˆECDICTç¦»çº¿è¯å…¸ã€‚

---

**Generated:** 2025-11-30  
**Status:** âœ… Complete  
**Next Phase:** Backend API Implementation

